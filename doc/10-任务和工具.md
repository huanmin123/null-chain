# 任务和工具

本文档介绍 `NullTask` 和 `NullTool` 的使用方法，用于执行自定义任务和工具操作。

## 概述

### NullTask - 任务

**任务**是实现 `NullTask` 接口的类，用于执行复杂的业务逻辑。

**特点**：
- 实现 `NullTask<T, R>` 接口，T 是输入类型，R 是输出类型
- 包含 `init()` 方法用于初始化
- 包含 `run()` 方法用于执行主要业务逻辑
- 支持参数校验（`checkTypeParams()`）
- 支持上下文管理（`context`）

### NullTool - 工具

**工具**是实现 `NullTool` 接口的类，用于执行简单的工具操作。

**特点**：
- 实现 `NullTool<T, R>` 接口，T 是输入类型，R 是输出类型
- 包含 `init()` 方法用于初始化
- 包含 `run()` 方法用于执行工具逻辑
- 支持参数校验（`checkTypeParams()`）
- 支持上下文管理（`context`）

## 创建任务

### 实现 NullTask 接口

```java
import com.gitee.huanminabc.nullchain.task.NullTask;
import com.gitee.huanminabc.nullchain.core.NullChain;
import com.gitee.huanminabc.nullchain.common.NullType;
import java.util.Map;

public class UserValidationTask implements NullTask<User, Boolean> {
    
    @Override
    public void init(User preValue, NullChain<?>[] params, Map<String, Object> context) throws Exception {
        // 初始化逻辑，如参数验证、资源准备等
        // context 不会传递到下一个任务
    }
    
    @Override
    public Boolean run(User preValue, NullChain<?>[] params, Map<String, Object> context) throws Exception {
        // 主要业务逻辑
        // 返回值会传递到下一个任务
        return preValue != null && preValue.getName() != null;
    }
    
    @Override
    public NullType checkTypeParams() {
        // 参数类型校验，返回 null 表示不校验
        return null;
    }
}
```

### 使用任务

```java
// 执行单个任务
Boolean isValid = Null.of(user)
    .task(UserValidationTask.class)
    .orElse(false);

// 带参数的任务
Boolean isValid = Null.of(user)
    .task(UserValidationTask.class, "param1", 123)
    .orElse(false);
```

## 创建工具

### 实现 NullTool 接口

```java
import com.gitee.huanminabc.nullchain.tool.NullTool;
import com.gitee.huanminabc.nullchain.core.NullChain;
import com.gitee.huanminabc.nullchain.common.NullType;
import java.util.Map;

public class MD5Tool implements NullTool<String, String> {
    
    @Override
    public void init(String preValue, NullChain<?>[] params, Map<String, Object> context) throws Exception {
        // 初始化逻辑
    }
    
    @Override
    public String run(String preValue, NullChain<?>[] params, Map<String, Object> context) throws Exception {
        // 计算 MD5 哈希值
        return HashUtil.md5(preValue);
    }
    
    @Override
    public NullType checkTypeParams() {
        // 参数类型校验，返回 null 表示不校验
        return null;
    }
}
```

### 使用工具

```java
// 执行工具
String hash = Null.of("test123")
    .tool(MD5Tool.class)
    .orElse("");

// 带参数的工具
String result = Null.of(data)
    .tool(MyTool.class, "param1", 123)
    .orElse("default");
```

## 任务组并发执行

### 创建任务组

```java
import com.gitee.huanminabc.nullchain.common.NullGroupTask;

// 创建任务组
NullGroupTask taskGroup = NullGroupTask.buildGroup(
    NullGroupTask.task(Test1Task.class.getName()),
    NullGroupTask.task(Test2Task.class.getName())
);
```

### 并发执行任务组

```java
// 并发执行任务组
Map<String, Object> results = Null.of(input)
    .task(taskGroup)
    .orElse(new HashMap<>());

// 获取任务结果
String result1 = (String) results.get(Test1Task.class.getName());
String result2 = (String) results.get(Test2Task.class.getName());
```

### 使用指定线程池

```java
// 使用指定线程池执行任务组
Map<String, Object> results = Null.of(input)
    .task(taskGroup, "customThreadPool")
    .orElse(new HashMap<>());
```

## 完整示例

### 任务示例

```java
public class UserProcessingTask implements NullTask<User, ProcessedUser> {
    
    @Override
    public void init(User preValue, NullChain<?>[] params, Map<String, Object> context) throws Exception {
        // 验证参数
        if (preValue == null) {
            throw new IllegalArgumentException("用户不能为空");
        }
        
        // 准备资源
        context.put("startTime", System.currentTimeMillis());
    }
    
    @Override
    public ProcessedUser run(User preValue, NullChain<?>[] params, Map<String, Object> context) throws Exception {
        // 处理用户数据
        ProcessedUser processed = new ProcessedUser();
        processed.setName(preValue.getName().toUpperCase());
        processed.setAge(preValue.getAge());
        
        // 记录处理时间
        Long startTime = (Long) context.get("startTime");
        Long duration = System.currentTimeMillis() - startTime;
        log.info("处理耗时: {}ms", duration);
        
        return processed;
    }
    
    @Override
    public NullType checkTypeParams() {
        return null;  // 不进行参数类型校验
    }
}
```

### 工具示例

```java
public class StringEncryptionTool implements NullTool<String, String> {
    
    @Override
    public void init(String preValue, NullChain<?>[] params, Map<String, Object> context) throws Exception {
        // 初始化加密工具
    }
    
    @Override
    public String run(String preValue, NullChain<?>[] params, Map<String, Object> context) throws Exception {
        // 加密字符串
        return EncryptionUtil.encrypt(preValue);
    }
    
    @Override
    public NullType checkTypeParams() {
        return null;
    }
}
```

### 使用示例

```java
public class TaskExample {
    
    public void useTask() {
        // 使用任务处理用户
        ProcessedUser processed = Null.of(user)
            .task(UserProcessingTask.class)
            .orElse(null);
    }
    
    public void useTool() {
        // 使用工具加密字符串
        String encrypted = Null.of("sensitive data")
            .tool(StringEncryptionTool.class)
            .orElse("");
    }
    
    public void useTaskGroup() {
        // 创建任务组
        NullGroupTask taskGroup = NullGroupTask.buildGroup(
            NullGroupTask.task(ValidationTask.class.getName()),
            NullGroupTask.task(ProcessingTask.class.getName()),
            NullGroupTask.task(NotificationTask.class.getName())
        );
        
        // 并发执行任务组
        Map<String, Object> results = Null.of(input)
            .task(taskGroup)
            .orElse(new HashMap<>());
        
        // 获取结果
        Boolean isValid = (Boolean) results.get(ValidationTask.class.getName());
        ProcessedData processed = (ProcessedData) results.get(ProcessingTask.class.getName());
    }
}
```

## 生命周期

### 任务生命周期

1. **参数校验**：`checkTypeParams()` - 验证参数类型
2. **初始化**：`init()` - 执行初始化逻辑
3. **业务执行**：`run()` - 执行主要业务逻辑

### 上下文管理

- `context` 是任务执行过程中的上下文信息
- 上下文信息**不会传递到下一个任务**
- 可以在 `init()` 中设置上下文，在 `run()` 中使用

## 注意事项

1. **参数传递**：参数通过 `params` 数组传递，需要手动解析
2. **异常处理**：任务中的异常需要自行处理，框架不会捕获
3. **上下文隔离**：每个任务的上下文是独立的，不会传递到下一个任务
4. **并发安全**：任务组并发执行时，需要注意线程安全问题
5. **类型安全**：通过泛型保证类型安全，编译期即可发现类型错误

## 与 NF 脚本的区别

- **任务/工具**：使用 Java 代码实现，编译期检查，性能更好
- **NF 脚本**：使用脚本语言实现，运行时执行，更灵活但性能略低

